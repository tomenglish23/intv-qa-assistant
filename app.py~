"""
Interview Q&A RAG Assistant - Flask API
Serves the Interview Q&A RAG system as a web service
"""
from flask import Flask, request, jsonify, render_template
from flask_cors import CORS
import os
from typing import List

from langchain_openai import OpenAIEmbeddings, ChatOpenAI
from langchain_chroma import Chroma
from langchain_core.documents import Document
from langchain_core.prompts import ChatPromptTemplate
from langgraph.graph import StateGraph, END

app = Flask(__name__)
CORS(app)

# Global variables
vector_store = None
doc_ingester = None
app_graph = None

DIR_DATA = "./data"
DIR_PERSIST = "./chroma_db"

# [Copy your entire DocIngester class here from iq_rag6.py]
# [Copy your entire VectorStore class here]
# [Copy your RAGState and create_rag_graph function here]

def initialize_system():
    """Initialize the RAG system on startup"""
    global vector_store, doc_ingester, app_graph
    
    print("=" * 70)
    print("Interview Q&A RAG Assistant - Initializing...")
    print("=" * 70)
    
    # Load documents
    doc_ingester = DocIngester(data_dir=DIR_DATA)
    docs = doc_ingester.load_docs()
    
    if not docs:
        print("ERROR: No documents found!")
        return False
    
    # Create vector store
    vector_store = VectorStore()
    vector_store.create_or_load(docs)
    
    # Create workflow
    app_graph = create_rag_graph(vector_store)
    
    print("? System ready!")
    return True


@app.route('/')
def index():
    """Health check endpoint"""
    return jsonify({
        "status": "ok",
        "service": "Interview Q&A RAG Assistant",
        "version": "1.0"
    })


@app.route('/api/query', methods=['POST'])
def query():
    """Handle query requests"""
    try:
        data = request.json
        question = data.get('question', '').strip()
        discipline = data.get('discipline')  # Optional filter
        
        if not question:
            return jsonify({"error": "Question is required"}), 400
        
        if not app_graph:
            return jsonify({"error": "System not initialized"}), 503
        
        # Run the RAG workflow
        result = app_graph.invoke({
            "q": question,
            "discipline": discipline,
            "rxd_docs": [],
            "ctx": "",
            "a": "",
            "confidence": 0.0,
            "use_fb": False,
            "sources": []
        })
        
        return jsonify({
            "answer": result["a"],
            "confidence": result["confidence"],
            "sources": result["sources"],
            "use_fallback": result["use_fb"],
            "discipline": result.get("discipline")
        })
        
    except Exception as e:
        print(f"Error processing query: {e}")
        return jsonify({"error": str(e)}), 500


@app.route('/api/disciplines', methods=['GET'])
def get_disciplines():
    """Get list of all Level 1 disciplines"""
    try:
        if not doc_ingester:
            return jsonify({"error": "System not initialized"}), 503
        
        disciplines = doc_ingester.get_level1()
        return jsonify({"disciplines": disciplines})
        
    except Exception as e:
        return jsonify({"error": str(e)}), 500


@app.route('/api/areas', methods=['GET'])
def get_areas():
    """Get Level 2 areas organized by discipline"""
    try:
        if not doc_ingester:
            return jsonify({"error": "System not initialized"}), 503
        
        areas = doc_ingester.get_level2()
        return jsonify({"areas": areas})
        
    except Exception as e:
        return jsonify({"error": str(e)}), 500


@app.route('/api/stats', methods=['GET'])
def stats():
    """Get system statistics"""
    try:
        if not doc_ingester:
            return jsonify({"error": "System not initialized"}), 503
        
        return jsonify({
            "disciplines": len(doc_ingester.level1),
            "areas": sum(len(areas) for areas in doc_ingester.level2.values()),
            "topics": sum(len(topics) for topics in doc_ingester.level3.values()),
            "status": "ready"
        })
        
    except Exception as e:
        return jsonify({"error": str(e)}), 500


if __name__ == '__main__':
    # Initialize system before starting server
    if initialize_system():
        port = int(os.environ.get('PORT', 5000))
        app.run(host='0.0.0.0', port=port)
    else:
        print("Failed to initialize system!")

